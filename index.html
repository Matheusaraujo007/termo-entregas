<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Termo de Entregas e Recebimentos de Materiais</title>
  <style>
    :root{
      --blue:#2fb1b3;
      --light:#eef6fb;
      --accent:#1d6fa5;
      --border:#c6d7e6;
      --paper:#fff;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }
    body{
      margin:0;
      padding:20px;
      background:linear-gradient(180deg,#f5f8fb, #ffffff);
      color:#222;
    }
    .container{
      max-width:1000px;
      margin:0 auto;
      background:var(--paper);
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      border-radius:8px;
      padding:18px;
    }
    header{
      display:flex;
      gap:80px;
      align-items:center;
      margin-bottom:6px;
      justify-content: space-between; /* separa título e logo nas extremidades */
    }
    
    h1{
      font-size:18px;
      margin:0;
      letter-spacing:0.6px;
    }
    p.sub{
      margin:2px 0 12px 0;
      font-size:13px;
      color:#444;
    }

    .client-info {
      background: var(--light);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .client-info .form-group {
      flex: 1 1 300px;
      display:flex;
      flex-direction: column;
      gap:6px;
    }

    .form-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .form-group{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:140px;
      flex:1;
    }
    label{ font-size:13px; color:#333; }
    input[type="text"], input[type="number"], input[type="date"]{
      padding:8px 10px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
    }
    input[type="number"]{ text-align:right; }

    .actions{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    button{
      cursor:pointer;
      padding:9px 12px;
      border-radius:6px;
      border:0;
      background:var(--accent);
      color:#fff;
      font-weight:600;
    }
    button.secondary{
      background:#6aa5d4;
    }
    button.ghost{
      background:transparent;
      border:1px solid var(--border);
      color:#333;
      font-weight:600;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:14px;
    }
    thead th{
      background:var(--blue);
      color:#fff;
      padding:8px;
      font-size:13px;
      text-align:left;
      border:1px solid rgba(255,255,255,0.06);
    }
    tbody td{
      padding:8px;
      border:1px solid var(--border);
      vertical-align:middle;
      background:#fff;
    }
    td.center{text-align:center;}
    td.right{text-align:right;}

    tfoot td{
      padding:10px 8px;
      border-top:2px solid var(--border);
      font-weight:700;
      background:var(--light);
    }

    .small{
      font-size:12px;
      color:#555;
    }

    .row-actions button{
      padding:6px 8px;
      font-size:12px;
      margin-right:6px;
    }

    /* NOVO: área para imprimir nome e endereço */
    .print-client-info {
      display: none;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .print-client-info span {
      margin-right: 30px;
    }

    @media (max-width:860px){
      .form-group{ min-width:unset; flex-basis:48%; }
      header{
        flex-direction: column;
        align-items: center; /* centraliza na coluna */
        gap: 8px;
        justify-content: center;
      }
      .logo {
        width: auto;
        border: none;
        background: transparent;
      }
      .logo img {
        height: 35px;
        width: auto;
      }
    }

    /* print styles */
    @media print{
      body{ background: #fff; }
      .container{ box-shadow:none; border-radius:0; padding:0; }
      .no-print{ display:none !important; }
      thead th{ background:#ddd !important; color:#000 !important; -webkit-print-color-adjust:exact; }
      /* Mostrar nome e endereço no topo da impressão */
      .print-client-info {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>TERMO DE ENTREGAS E RECEBIMENTOS DE MATERIAIS</h1>
        <p class="sub">Preencha os campos abaixo para registrar entradas e saídas de materiais.</p>
      </div>
      <div class="logo">
        <!-- Se quiser colocar logo aqui -->
      </div>
    </header>

    <!-- Formulário com inputs nome e endereço -->
    <div class="client-info no-print">
      <div class="form-group">
        <label>Nome do Cliente</label>
        <input id="cliente" type="text" placeholder="Nome do cliente" />
      </div>
      <div class="form-group">
        <label>Endereço</label>
        <input id="endereco" type="text" placeholder="Endereço completo" />
      </div>
    </div>

    <!-- Esta div será exibida apenas na impressão com nome e endereço -->
    <div class="print-client-info"></div>

    <div class="no-print">
      <div class="form-row">
        <div class="form-group">
          <label>Quantidade</label>
          <input id="quant" type="number" min="1" step="1" value="1" />
        </div>
        <div class="form-group" style="flex:2">
          <label>Descrição do material alugado</label>
          <input id="desc" type="text" placeholder="Ex: Andaime, Betoneira, Estribo..." />
        </div>
        <div class="form-group">
          <label>Data de entrada na obra</label>
          <input id="dataEntrada" type="date" />
        </div>
        <div class="form-group">
          <label>Data de saída da obra</label>
          <input id="dataSaida" type="date" />
        </div>
        <div class="form-group">
          <label>Diária (dias)</label>
          <input id="diaria" type="number" min="0" step="1" value="0" readonly />
        </div>
        <div class="form-group">
          <label>Valor unitário (R$)</label>
          <input id="valorUnit" type="number" min="0" step="0.01" value="0.00" />
        </div>
        <div class="actions" style="align-items:center">
          <button id="addBtn">Adicionar</button>
          <button id="clearBtn" class="secondary">Limpar</button>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button id="printBtn" class="ghost">Imprimir / Salvar PDF</button>
        <button id="exportBtn" class="ghost">Exportar CSV</button>
      </div>
    </div>

    <table id="tb">
      <thead>
        <tr>
          <th style="width:70px">QUANT.</th>
          <th>DESCRIÇÃO DO MATERIAL ALUGADO</th>
          <th style="width:130px">DATA DE ENTRADA</th>
          <th style="width:130px">DATA DE SAÍDA</th>
          <th style="width:100px">DIÁRIA</th>
          <th style="width:120px">VALOR UNITÁRIO (R$)</th>
          <th style="width:120px">TOTAL (R$)</th>
          <th style="width:120px" class="no-print">AÇÕES</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <!-- linhas serão adicionadas aqui -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="6" class="right">TOTAL GERAL</td>
          <td id="grandTotal" class="right">R$ 0,00</td>
          <td class="no-print"></td>
        </tr>
      </tfoot>
    </table>

  </div>

  <script>
    // util: formatar número em reais
    function formatBRL(num){
      return 'R$ ' + Number(num || 0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    // util: parse seguro
    function toNumber(val){
      const n = Number(String(val).replace(',', '.'));
      return isNaN(n) ? 0 : n;
    }

    const tbody = document.getElementById('tbody');
    const grandTotalEl = document.getElementById('grandTotal');
    const printClientInfoEl = document.querySelector('.print-client-info');

    // Atualiza campo diária com a quantidade de dias entre entrada e saída
    function atualizaDiaria() {
      const dataEntrada = document.getElementById('dataEntrada').value;
      const dataSaida = document.getElementById('dataSaida').value;
      if(dataEntrada && dataSaida){
        const dtEntrada = new Date(dataEntrada);
        const dtSaida = new Date(dataSaida);
        const diffTime = dtSaida - dtEntrada;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // inclui o dia de entrada
        document.getElementById('diaria').value = diffDays > 0 ? diffDays : 0;
      } else {
        document.getElementById('diaria').value = 0;
      }
    }

    document.getElementById('dataEntrada').addEventListener('change', atualizaDiaria);
    document.getElementById('dataSaida').addEventListener('change', atualizaDiaria);

    function atualizaTotalGeral(){
      let sum = 0;
      tbody.querySelectorAll('tr').forEach(row=>{
        const totalCell = row.querySelector('.col-total');
        const val = toNumber(totalCell.dataset.value);
        sum += val;
      });
      grandTotalEl.textContent = formatBRL(sum);
    }

    function criaLinha(obj){
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="center">${obj.quant}</td>
        <td>${obj.desc}</td>
        <td class="center small">${obj.dataEntrada || ''}</td>
        <td class="center small">${obj.dataSaida || ''}</td>
        <td class="right small">${(obj.diaria)}</td>
        <td class="right small">${formatBRL(obj.valorUnit)}</td>
        <td class="right col-total" data-value="${obj.total}">${formatBRL(obj.total)}</td>
        <td class="row-actions no-print" style="text-align:center">
          <button class="ghost btn-edit">Editar</button>
          <button class="ghost btn-delete">Excluir</button>
        </td>
      `;

      // eventos editar/excluir
      tr.querySelector('.btn-delete').addEventListener('click', ()=>{
        if(confirm('Deseja remover esta linha?')){
          tr.remove();
          atualizaTotalGeral();
        }
      });

      tr.querySelector('.btn-edit').addEventListener('click', ()=>{
        // preencher o formulário com os valores para editar
        document.getElementById('quant').value = obj.quant;
        document.getElementById('desc').value = obj.desc;
        document.getElementById('dataEntrada').value = obj.dataEntrada;
        document.getElementById('dataSaida').value = obj.dataSaida;
        document.getElementById('diaria').value = Number(obj.diaria);
        document.getElementById('valorUnit').value = Number(obj.valorUnit).toFixed(2);

        tr.remove();
        atualizaTotalGeral();
      });

      tbody.appendChild(tr);
      atualizaTotalGeral();
    }

    document.getElementById('addBtn').addEventListener('click', ()=>{
      const cliente = document.getElementById('cliente').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      const quant = Math.max(1, Math.floor(toNumber(document.getElementById('quant').value) || 0));
      const desc = document.getElementById('desc').value.trim();
      const dataEntrada = document.getElementById('dataEntrada').value;
      const dataSaida = document.getElementById('dataSaida').value;
      const diaria = toNumber(document.getElementById('diaria').value);
      const valorUnit = toNumber(document.getElementById('valorUnit').value);

      if(!cliente){
        alert('Por favor, preencha o nome do cliente.');
        return;
      }
      if(!endereco){
        alert('Por favor, preencha o endereço.');
        return;
      }
      if(!desc){
        alert('Por favor, preencha a descrição do material.');
        return;
      }
      if(diaria <= 0){
        alert('Por favor, informe uma data de saída maior ou igual à data de entrada.');
        return;
      }

      // total = diária * valor unitário
      const total = diaria * valorUnit;

      const obj = {
        cliente,
        endereco,
        quant,
        desc,
        dataEntrada,
        dataSaida,
        diaria,
        valorUnit,
        total
      };

      criaLinha(obj);

      // Limpar formulário (exceto nome e endereço)
      document.getElementById('quant').value = 1;
      document.getElementById('desc').value = '';
      document.getElementById('dataEntrada').value = '';
      document.getElementById('dataSaida').value = '';
      document.getElementById('diaria').value = 0;
      document.getElementById('valorUnit').value = '0.00';
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('quant').value = 1;
      document.getElementById('desc').value = '';
      document.getElementById('dataEntrada').value = '';
      document.getElementById('dataSaida').value = '';
      document.getElementById('diaria').value = 0;
      document.getElementById('valorUnit').value = '0.00';
    });

    document.getElementById('printBtn').addEventListener('click', ()=>{
      // Atualiza a div de impressão com os valores atuais
      const cliente = document.getElementById('cliente').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      printClientInfoEl.innerHTML = `
        <span><strong>Nome:</strong> ${cliente || '__________'}</span>
        <span><strong>Endereço:</strong> ${endereco || '__________'}</span>
      `;
      window.print();
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const rows = [];
      // Cabeçalho: sem cliente e endereço
      const header = ['QUANT','DESCRIÇÃO','DATA_ENTRADA','DATA_SAÍDA','DIÁRIA','VALOR_UNITÁRIO','TOTAL'];
      rows.push(header.join(';'));

      tbody.querySelectorAll('tr').forEach(tr=>{
        const cols = tr.querySelectorAll('td');
        const r = [
          cols[0].textContent.trim(),
          '"'+cols[1].textContent.trim().replace(/"/g,'""')+'"',
          cols[2].textContent.trim(),
          cols[3].textContent.trim(),
          cols[4].textContent.replace('R$','').trim().replace('.','').replace(',','.'),
          cols[5].textContent.replace('R$','').trim().replace('.','').replace(',','.'),
          cols[6].textContent.replace('R$','').trim().replace('.','').replace(',','.')
        ];
        rows.push(r.join(';'));
      });

      const csv = rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'termo_entregas_materiais.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
